if($(function(){var t={},e=!1,n=!1,o=!0,r=null,i=Date.now(),a="",s=(window.setInterval(function(){$.ajax({url:"/ping",type:"GET",complete:function(t,e){0!=t.status?n&&location.reload(!0):x("offline")}})},5e3),$("#background")),u=0,c=.015,l=.75,p=null,h=!1,f=window.setTimeout(C,2500);function d(){if(!n){var o=t.artists[0].name;if(t.artists.length>1)for(var r=1;r<t.artists.length;r++)o+=", "+t.artists[r].name;$("#track_name").text(t.name),$("#track_artist").text(o),$("#track_album_art").attr("src",t.art_url),$("#track_time_duration").text(k(t.duration)),$("#track_position_slider").prop("max",t.duration),e?t.paused?$("#play_pause").html("play_circle_outline"):$("#play_pause").html("pause_circle_outline"):$("#play_pause").html("remove_circle_outline")}}function v(){n||($("#track_time_position").text(k(t.position)),$("#track_position_slider").val(t.position))}function g(){t={id:"",name:"...",artists:[{name:"..."}],paused:!0,position:0,duration:0,art_url:"/images/spotify-640x640.png",type:"",features:{tempo:50,energy:.5,loudness:.5,valence:.5},palette:[[36,212,92],[209,245,221],[112,224,151],[139,228,172],[84,220,132],[73,216,121]]},console.log(t),y(),d(),v(),I(t.features),_()}function m(e){n&&("#error_banner".animate({bottom:"+=40px"},500),n=!1,g()),o&&(o=!1),t.name="Ready To Play.",t.artists[0].name="Visit any Spotify player and choose 'Custom LED Player' as a device."}function _(){u>360&&(u=0),s.css("background","linear-gradient("+u+"deg,rgba("+t.palette[0][0]+","+t.palette[0][1]+","+t.palette[0][2]+","+l+"),rgba("+t.palette[1][0]+","+t.palette[1][1]+","+t.palette[1][2]+","+l+"),rgba("+t.palette[2][0]+","+t.palette[2][1]+","+t.palette[2][2]+","+l+"),rgba("+t.palette[3][0]+","+t.palette[3][1]+","+t.palette[3][2]+","+l+"),rgba("+t.palette[4][0]+","+t.palette[4][1]+","+t.palette[4][2]+","+l+"),rgba("+t.palette[5][0]+","+t.palette[5][1]+","+t.palette[5][2]+","+l+")"),u+=c}function b(){p||(p=window.setInterval(_,17)),r||(r=window.setInterval(w,17))}function y(){p&&(window.clearInterval(p),p=null),r&&(window.clearInterval(r),r=null)}function w(){n||i+50<Date.now()&&(i=Date.now(),t.position+=55,v())}function k(t){var e="",n=parseInt(t/36e5%24),o=parseInt(t/6e4%60).toString(),r=parseInt(t/1e3%60).toString();return r<=9&&(r="0"+r),o<=9&&(o="0"+o),n<=9&&(n="0"+n),"00"!=n&&(e+=n+":"),e+=o+":"+r}function x(t){if(g(),console.error(t),!n){n=!0;var e="Oops - Something went wrong (code: "+t+").";$("#error_banner p").text(e),$("#error_banner").animate({bottom:"-=40px"},1e3)}}function I(t){c=Number((t.tempo*t.energy/2500).toPrecision(2)),l=.5+(t.valence+t.loudness)/4,console.log(l)}function C(){h=!0,$(document.body).css("cursor","none"),$("#control_container").animate({opacity:0},1500)}window.onSpotifyWebPlaybackSDKReady=(()=>{const n=new Spotify.Player({name:"Colourful Player",getOAuthToken:t=>{!function(t){console.log("getting new token"),$.get("/auth/token/new",function(e){e.error?"refresh_token_expired"==e.error.reason?(console.log("App has become unauthorised."),x("refresh_token_expired")):console.log("Unknown Error."):(console.log("token success"),t(e.access_token))})}(function(e){t(e),a=e})}});n.addListener("initialization_error",({message:t})=>{x("init_err")}),n.addListener("authentication_error",({message:t})=>{x("auth_err")}),n.addListener("account_error",({message:t})=>{x("acc_err'")}),n.addListener("playback_error",({message:t})=>{x("play_err")}),n.addListener("player_state_changed",n=>{n?(e=!0,n.track_window.current_track.id!=t.id&&function(e){t.id=e.id,t.name=e.name,t.art_url=e.album.images[2].url,t.artists=e.artists,t.duration=e.duration_ms,t.type=e.type,n=t.art_url,o=6,r=function(e){t.palette=e,function(t,e){var n={};if("track"==t.type){var o="https://api.spotify.com/v1/audio-features/"+t.id;$.ajax({url:o,type:"GET",beforeSend:function(t){t.setRequestHeader("Authorization","Bearer "+a)},success:function(t){(n={tempo:t.tempo,energy:t.energy,loudness:t.loudness,valence:t.valence}).loudness<-15&&(n.loudness=-15),n.loudness=Number(((n.loudness+15)/15).toPrecision(3)),console.log("features recieved"),e(n)},error:function(){e({tempo:50,energy:.5,loudness:.5,valence:.5})}})}else e({tempo:50,energy:.5,loudness:.5,valence:.5})}(t,function(e){t.features=e,I(t.features),_()})},i=new Image,i.crossOrigin="Anonymous",i.src=n,i.onload=function(t){r(paletteFromImage(t,o))},console.log(t);var n,o,r,i}(n.track_window.current_track),n.paused&&!t.paused&&(t.paused=!0,y()),!n.paused&&t.paused&&(t.paused=!1,b()),t.position=n.position):(e=!1,console.warn("No longer the active player!"),g(),m()),d(),v()}),n.addListener("ready",({device_id:t})=>{m(),d(),console.log("Ready with Device ID",t)}),n.addListener("not_ready",({device_id:t})=>{x("device_offline"),console.log("Device ID has gone offline",t)}),$("#play_pause").click(function(){e&&n.togglePlay().then(()=>{console.log("Toggled playback!")})}),$("#skip_prev").click(function(){e&&n.previousTrack().then(()=>{console.log("Set to previous track!")})}),$("#skip_next").click(function(){e&&n.nextTrack().then(()=>{console.log("Skipped to next track!")})}),$("#track_position_slider").on("mousedown",function(){e&&y()}),$("#track_position_slider").on("input",function(){e&&(t.position=$("#track_position_slider").val(),v())}),$("#track_position_slider").on("change",function(){e&&n.seek($("#track_position_slider").val()).then(()=>{console.log("Changed position!"),b()})}),n.connect()}),$(document).mousemove(function(){window.clearTimeout(f),h&&(h=!1,$("#control_container").stop(),$(document.body).css("cursor","default"),$("#control_container").css("opacity","1")),f=window.setTimeout(C,2500)}),g()}),!pv)var pv={map:function(t,e){var n={};return e?t.map(function(t,o){return n.index=o,e.call(n,t)}):t.slice()},naturalOrder:function(t,e){return t<e?-1:t>e?1:0},sum:function(t,e){var n={};return t.reduce(e?function(t,o,r){return n.index=r,t+e.call(n,o)}:function(t,e){return t+e},0)},max:function(t,e){return Math.max.apply(null,e?pv.map(t,e):t)}};var MMCQ=function(){var t=5,e=8-t,n=1e3,o=.75;function r(e,n,o){return(e<<2*t)+(n<<t)+o}function i(t){var e=[],n=!1;function o(){e.sort(t),n=!0}return{push:function(t){e.push(t),n=!1},peek:function(t){return n||o(),void 0===t&&(t=e.length-1),e[t]},pop:function(){return n||o(),e.pop()},size:function(){return e.length},map:function(t){return e.map(t)},debug:function(){return n||o(),e}}}function a(t,e,n,o,r,i,a){this.r1=t,this.r2=e,this.g1=n,this.g2=o,this.b1=r,this.b2=i,this.histo=a}function s(){this.vboxes=new i(function(t,e){return pv.naturalOrder(t.vbox.count()*t.vbox.volume(),e.vbox.count()*e.vbox.volume())})}function u(t,e){if(e.count()){var n=e.r2-e.r1+1,o=e.g2-e.g1+1,i=e.b2-e.b1+1,a=pv.max([n,o,i]);if(1==e.count())return[e.copy()];var s,u,c,l,p=0,h=[],f=[];if(a==n)for(s=e.r1;s<=e.r2;s++){for(l=0,u=e.g1;u<=e.g2;u++)for(c=e.b1;c<=e.b2;c++)l+=t[r(s,u,c)]||0;p+=l,h[s]=p}else if(a==o)for(s=e.g1;s<=e.g2;s++){for(l=0,u=e.r1;u<=e.r2;u++)for(c=e.b1;c<=e.b2;c++)l+=t[r(u,s,c)]||0;p+=l,h[s]=p}else for(s=e.b1;s<=e.b2;s++){for(l=0,u=e.r1;u<=e.r2;u++)for(c=e.g1;c<=e.g2;c++)l+=t[r(u,c,s)]||0;p+=l,h[s]=p}return h.forEach(function(t,e){f[e]=p-t}),d(a==n?"r":a==o?"g":"b")}function d(t){var n,o,r,i,a,u=t+"1",c=t+"2",l=0;for(s=e[u];s<=e[c];s++)if(h[s]>p/2){for(r=e.copy(),i=e.copy(),a=(n=s-e[u])<=(o=e[c]-s)?Math.min(e[c]-1,~~(s+o/2)):Math.max(e[u],~~(s-1-n/2));!h[a];)a++;for(l=f[a];!l&&h[a-1];)l=f[--a];return r[c]=a,i[u]=r[c]+1,[r,i]}}}return a.prototype={volume:function(t){return this._volume&&!t||(this._volume=(this.r2-this.r1+1)*(this.g2-this.g1+1)*(this.b2-this.b1+1)),this._volume},count:function(t){var e=this.histo;if(!this._count_set||t){var n,o,i,a=0;for(n=this.r1;n<=this.r2;n++)for(o=this.g1;o<=this.g2;o++)for(i=this.b1;i<=this.b2;i++)index=r(n,o,i),a+=e[index]||0;this._count=a,this._count_set=!0}return this._count},copy:function(){return new a(this.r1,this.r2,this.g1,this.g2,this.b1,this.b2,this.histo)},avg:function(e){var n=this.histo;if(!this._avg||e){var o,i,a,s,u=0,c=1<<8-t,l=0,p=0,h=0;for(i=this.r1;i<=this.r2;i++)for(a=this.g1;a<=this.g2;a++)for(s=this.b1;s<=this.b2;s++)u+=o=n[r(i,a,s)]||0,l+=o*(i+.5)*c,p+=o*(a+.5)*c,h+=o*(s+.5)*c;u?this._avg=[~~(l/u),~~(p/u),~~(h/u)]:(console.log("empty box"),this._avg=[~~(c*(this.r1+this.r2+1)/2),~~(c*(this.g1+this.g2+1)/2),~~(c*(this.b1+this.b2+1)/2)])}return this._avg},contains:function(t){var n=t[0]>>e;return gval=t[1]>>e,bval=t[2]>>e,n>=this.r1&&n<=this.r2&&gval>=this.g1&&n<=this.g2&&bval>=this.b1&&n<=this.b2}},s.prototype={push:function(t){this.vboxes.push({vbox:t,color:t.avg()})},palette:function(){return this.vboxes.map(function(t){return t.color})},size:function(){return this.vboxes.size()},map:function(t){for(var e=this.vboxes,n=0;n<e.size();n++)if(e.peek(n).vbox.contains(t))return e.peek(n).color;return this.nearest(t)},nearest:function(t){for(var e,n,o,r=this.vboxes,i=0;i<r.size();i++)((n=Math.sqrt(Math.pow(t[0]-r.peek(i).color[0],2)+Math.pow(t[1]-r.peek(i).color[1],2)+Math.pow(t[1]-r.peek(i).color[1],2)))<e||void 0===e)&&(e=n,o=r.peek(i).color);return o},forcebw:function(){var t=this.vboxes;t.sort(function(t,e){return pv.naturalOrder(pv.sum(t.color),pv.sum(e.color))});var e=t[0].color;e[0]<5&&e[1]<5&&e[2]<5&&(t[0].color=[0,0,0]);var n=t.length-1,o=t[n].color;o[0]>251&&o[1]>251&&o[2]>251&&(t[n].color=[255,255,255])}},{quantize:function(c,l){if(!c.length||l<2||l>256)return console.log("wrong number of maxcolors"),!1;var p=function(n){var o,i,a,s,u=new Array(1<<3*t);return n.forEach(function(t){i=t[0]>>e,a=t[1]>>e,s=t[2]>>e,o=r(i,a,s),u[o]=(u[o]||0)+1}),u}(c);p.forEach(function(){});var h=function(t,n){var o,r,i,s=1e6,u=0,c=1e6,l=0,p=1e6,h=0;return t.forEach(function(t){o=t[0]>>e,r=t[1]>>e,i=t[2]>>e,o<s?s=o:o>u&&(u=o),r<c?c=r:r>l&&(l=r),i<p?p=i:i>h&&(h=i)}),new a(s,u,c,l,p,h,n)}(c,p),f=new i(function(t,e){return pv.naturalOrder(t.count(),e.count())});function d(t,e){for(var o,r=1,i=0;i<n;)if((o=t.pop()).count()){var a=u(p,o),s=a[0],c=a[1];if(!s)return void console.log("vbox1 not defined; shouldn't happen!");if(t.push(s),c&&(t.push(c),r++),r>=e)return;if(i++>n)return void console.log("infinite loop; perhaps too few pixels!")}else t.push(o),i++}f.push(h),d(f,o*l);for(var v=new i(function(t,e){return pv.naturalOrder(t.count()*t.volume(),e.count()*e.volume())});f.size();)v.push(f.pop());d(v,l-v.size());for(var g=new s;v.size();)g.push(v.pop());return g}}}();function paletteFromImage(t,e){for(var n,o,r,i,a=(t=new CanvasImage(t.target)).getImageData().data,s=t.getPixelCount(),u=[],c=0;c<s;c+=4)o=a[(n=4*c)+0],r=a[n+1],i=a[n+2],a[n+3]>=125&&(o>250&&r>250&&i>250||u.push([o,r,i]));return t.removeCanvas(),MMCQ.quantize(u,e).palette()}var CanvasImage=function(t){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=t.width,this.height=this.canvas.height=t.height,this.context.drawImage(t,0,0,this.width,this.height)};CanvasImage.prototype.getPixelCount=function(){return this.width*this.height},CanvasImage.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},CanvasImage.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};
//# sourceMappingURL=bundle.min.js.map
